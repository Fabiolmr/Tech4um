{% extends 'base.html' %}

{% block content %}

<!-- HEADER SIMPLES (apenas logo à esquerda) -->
<header class="header">
    <div class="logo">TECH4UM</div>
    <!-- nenhuma search bar, nada mais -->
</header>

<!-- SIDEBAR PADRÃO -->
<div class="sidebar">

    <!-- Perfil -->
    <div class="user-info">
        <p>@{{ username }}</p>
        <button onclick="window.location.href='/logout'">Sair</button>
    </div>

    <!-- Menu -->
    <div class="sidebar-section">
        <ul>
            <li onclick="window.location.href='/feed'">
                <img src="/static/icons/list.svg" class="sideicon" alt="">
                Feed
            </li>

            <li onclick="window.location.href='/forums'">
                <img src="/static/icons/forum.svg" class="sideicon" alt="">
                Fóruns
            </li>

            <li onclick="window.location.href='/settings'">
                <img src="/static/icons/settings.svg" class="sideicon" alt="">
                Configurações
            </li>
        </ul>
    </div>

</div>


<div class="chat-wrapper">

    <!-- ÁREA DO CHAT -->
    <div class="chat-area">

        <div class="chat-header">
            <h2>CHAT - {{ room }}</h2>
        </div>

        <!-- MENSAGENS -->
        <div class="messages" id="messages">
            {% for msg in messages %}
        <div>{{ msg }}</div> {% endfor %}
        </div>

        <!-- INPUT -->
        <div class="inputs">
        <input 
        type="text"
        placeholder="Message"
        id="message" />
    <button type="button" id="send-btn" onclick="sendMessage()"> Enviar
    </button>
</div>

    </div>

    <!-- PARTICIPANTES -->
    <div class="sidebar-users">
    <h3>Usuários (Online / Offline)</h3>
    <div id="users-list"></div> </div>

</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<script type="text/javascript">
    // Garante que o Socket.IO está carregado ao voltar de cache/histórico
    window.addEventListener( "pageshow", function ( event ) {
      var historyTraversal = event.persisted || 
                             ( typeof window.performance != "undefined" && 
                                  window.performance.navigation.type === 2 );
      if ( historyTraversal ) {
        window.location.reload();
      }
    });

    const socketio = io();
    const currentUsername = "{{ username }}"; // Variável para o seu nome de usuário

    // Entrar na sala
    socketio.on('connect', () => {
        console.log("Conectado! Enviando join...");
        socketio.emit("join", {
            room: "{{ room }}",
            username: currentUsername
        });
        
        // Solicita lista completa de usuários ao entrar na página
        socketio.emit("get_users", { room: "{{ room }}" });
    });

    socketio.on("error_redirect", (data) => {
        alert("A sala foi encerrada ou reiniciada. Você será redirecionado.");
        window.location.href = data.url;
    });

    // Função que adiciona mensagens no chat, adaptada para o novo estilo
    function addMessage(text) {
        const messagesContainer = document.getElementById("messages");
        if (!messagesContainer) return; // Segurança

        const div = document.createElement("div");
        
        // Verifica se a mensagem contém o seu username para estilização
        // Seu backend envia mensagens como "USERNAME: Mensagem"
        if (text.startsWith(currentUsername + ":")) {
            // Estilo para a minha própria mensagem (pode ser "msg-me" ou similar no seu CSS)
            div.className = "msg-me"; 
        } else if (text.includes("entrou na sala") || text.includes("saiu da sala")) {
            // Estilo para mensagens do sistema
            div.className = "msg-system";
        } else {
            // Estilo para mensagens de outros usuários
            div.className = "msg-other"; 
        }

        // Se o seu CSS usa <p> dentro da div, use:
        // div.innerHTML = `<p class="msg-text">${text}</p>`;
        // Senão, use o simples (que é o que o seu script antigo fazia):
        div.innerText = text;
        
        messagesContainer.appendChild(div);
        
        // Rolar para baixo automaticamente
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Recebe mensagens normais
    socketio.on("message", (data) => {
        addMessage(data);
    });

    // Recebe lista de TODOS os usuários do backend
    socketio.on("users_list", (users) => {
        const container = document.getElementById("users-list");
        if (!container) return;
        
        container.innerHTML = "";

        users.forEach(user => {
            const div = document.createElement("div");
            div.classList.add("user-item");

            const status = document.createElement("span");
            status.classList.add("user-status");

            if (user.online === true) {
                status.classList.add("online");
            } else {
                status.classList.add("offline");
            }

            const usernameElement = document.createElement("span");
            usernameElement.textContent = user.username;

            div.appendChild(status);
            div.appendChild(usernameElement);

            container.appendChild(div);
        });
    });

    // Enviar mensagem (esta função é chamada pelo onclick="sendMessage()" do botão)
    function sendMessage() {
        const input = document.getElementById("message");
        const text = input.value;

        if (text.trim() === "") return;

        socketio.emit("message", {
            room: "{{ room }}",
            username: currentUsername,
            message: text
        });

        input.value = "";
    }

    // Ao fechar página
    window.addEventListener("beforeunload", () => {
        socketio.emit("leave", {
            room: "{{ room }}",
            username: currentUsername
        });
    });
</script>

{% endblock %}
