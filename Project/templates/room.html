{% extends 'base.html' %}

{% block content %}

<!-- BOTÃO DE LOGOUT FIXO NO TOPO DIREITO -->
{% if current_user.is_authenticated %}
<div style="position: fixed; top: 10px; right: 10px; z-index: 1000;">
    <a href="{{ url_for('auth.logout') }}"
       style="padding: 5px 10px; background-color: #ff4d4d; color: white; text-decoration: none; border-radius: 4px;">
        Logout
    </a>
</div>
{% endif %}

<!-- CONTEÚDO DO CHAT -->
<div class="message-box">
    <h2>Chat Room: {{ room }} </h2>

    <div class="messages" id="messages">
        {% for msg in messages %}
            <div>{{ msg }}</div>
        {% endfor %}
    </div>

    <div class="inputs">
        <input 
            type="text"
            placeholder="Message"
            id="message"
        />
        <button type="button" id="send-btn" onclick="sendMessage()">
            Enviar
        </button>
    </div>
</div>

<div class="header-chat">
    <a href="{{ url_for('main.home') }}" class="btn-voltar">← Voltar para Salas</a>
    <h2>Chat Room: {{ room }}</h2>
</div>

<!-- PARTICIPANTES DA SALA ATUAL -->
<div class="participantes">
    <h3>Participantes da Sala</h3>
    <ul id="participants-list">
        {% for user in participantes %}
            <li>{{ user.username }}</li>
        {% endfor %}
    </ul>
</div>

<!-- LISTA LATERAL: TODOS OS USUÁRIOS -->
<div class="sidebar-users">
    <h3>Usuários (Online / Offline)</h3>
    <div id="users-list"></div> <!-- ← LISTA DE TODOS OS USUÁRIOS -->
</div>

<style>
    .user-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 5px;
    }

    .user-status {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
    }

    .online {
        background-color: #00cc44;
    }

    .offline {
        background-color: #cc0000;
    }
</style>

<script type="text/javascript">

    const socketio = io();

    // Entrar na sala
    socketio.emit("join", {
        room: "{{ room }}",
        username: "{{ username }}"
    });

    // Função que adiciona mensagens no chat
    function addMessage(text) {
        const messages = document.getElementById("messages");
        const div = document.createElement("div");
        div.innerText = text;
        messages.appendChild(div);
    }

    // Recebe mensagens normais
    socketio.on("message", (data) => {
        addMessage(data);
    });

    // Atualiza lista de PARTICIPANTES DA SALA
    socketio.on("update_participants", (data) => {
        const container = document.getElementById("participants-list");
        container.innerHTML = "";
        
        data.users.forEach(user => {
            const li = document.createElement("li");
            li.textContent = user.username;
            container.appendChild(li);
        });
    });

    // Recebe lista de TODOS os usuários do backend
    socketio.on("users_list", (users) => {
        const container = document.getElementById("users-list");
        container.innerHTML = "";

        users.forEach(user => {
            const div = document.createElement("div");
            div.classList.add("user-item");

            const status = document.createElement("span");
            status.classList.add("user-status");

            if (user.online === true) {
                status.classList.add("online");
            } else {
                status.classList.add("offline");
            }

            const username = document.createElement("span");
            username.textContent = user.username;

            div.appendChild(status);
            div.appendChild(username);

            container.appendChild(div);
        });
    });

    // Solicita lista completa de usuários ao abrir a página
    socketio.emit("get_users", { room: "{{ room }}" });

    // Enviar mensagem
    function sendMessage() {
        const input = document.getElementById("message");
        const text = input.value;

        if (text.trim() === "") return;

        socketio.emit("message", {
            room: "{{ room }}",
            username: "{{ username }}",
            message: text
        });

        input.value = "";
    }

    // Ao fechar página
    window.addEventListener("beforeunload", () => {
        socketio.emit("leave", {
            room: "{{ room }}",
            username: "{{ username }}"
        });
        // ❌ REMOVIDO: socketio.disconnect();
    });


</script>

{% endblock %}
