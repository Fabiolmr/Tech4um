{% extends 'base.html' %}

{% block content %}

<!-- BOTÃO DE LOGOUT FIXO NO TOPO DIREITO -->
{% if current_user.is_authenticated %}
<div style="position: fixed; top: 10px; right: 10px; z-index: 1000;">
    <a href="{{ url_for('auth.logout') }}"
       style="padding: 5px 10px; background-color: #ff4d4d; color: white; text-decoration: none; border-radius: 4px;">
        Logout
    </a>
</div>
{% endif %}

<!-- CONTEÚDO DO CHAT -->
<div class="message-box">
    <h2>Chat Room: {{ room }} </h2>

    <div class="messages" id="messages">
        {% for msg in messages %}
            <div>{{ msg }}</div>
        {% endfor %}
    </div>

    <div class="inputs">
        <input 
            type="text"
            placeholder="Message"
            id="message"
        />
        <button type="button" id="send-btn" onclick="sendMessage()">
            Enviar
        </button>
    </div>
</div>

<div class="participantes">
    <h3>Participantes</h3>
    <ul id="participants-list">
        {% for user in participantes %}
            <li>{{ user.username }}</li>
        {% endfor %}
    </ul>
</div>

<script type="text/javascript">
    // Conectar ao backend Socket.IO
    const socketio = io();

    // Entrar na sala assim que a página abrir
    socketio.emit("join", {
        room: "{{ room }}",
        username: "{{ username }}"
    });

    // Função para mostrar mensagens na tela
    function addMessage(text) {
        const messages = document.getElementById("messages");
        const div = document.createElement("div");
        div.innerText = text;
        messages.appendChild(div);
    }

    // Evento recebido do backend (Flask-SocketIO usa "message")
    socketio.on("message", (data) => {
        addMessage(data);
    });

    socketio.on("update_participants", (data) =>{
        const listElement = document.getElementById("participants-list");
        listElement.innerHTML = "";

        data.users.forEach(user =>{
            const li = document.createElement("li");
            li.innerText = user.username;
            listElement.appendChild(li);
        });
    });

    // Enviar mensagem ao backend
    function sendMessage() {
        const messageInput = document.getElementById("message");
        const message = messageInput.value;

        if (message.trim() === "") return;

        socketio.emit("message", {
            room: "{{ room }}",
            username: "{{ username }}",
            message: message
        });

        messageInput.value = "";
    }

    // Ao sair ou atualizar a página — avisar backend e fechar conexão
    window.addEventListener("beforeunload", () => {
        socketio.emit("leave", {
            room: "{{ room }}",
            username: "{{ username }}"
        });
        socketio.disconnect();
    });
</script>

{% endblock %}
