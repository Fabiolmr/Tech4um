{% extends 'base.html' %}

{% block content %}

<div class="home-container">

    <!-- ================= HEADER SUPERIOR ================= -->
    <header class="home-header">
        <h2 class="logo">MinhaHome</h2>

        <div class="header-actions">
            {% if current_user.is_authenticated %}
                <span class="user-welcome">Olá, {{ current_user.username }}</span>
                <a href="{{ url_for('auth.logout') }}" class="btn small-btn">Sair</a>
            {% else %}
                <a href="{{ url_for('auth.login') }}" class="btn small-btn">Login</a>
                <a href="{{ url_for('auth.register') }}" class="btn small-btn">Register</a>
            {% endif %}
        </div>
    </header>


    <!-- ================= FLASH MESSAGES ================= -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="flash-container">
            {% for category, message in messages %}
                <div class="flash-message {{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
    {% endwith %}



    <!-- ================= LAYOUT PRINCIPAL ================= -->
    <div class="home-layout">


        <!-- ================= ESQUERDA: SIDEBAR ================= -->
        <aside class="left-sidebar">

            {% if current_user.is_authenticated %}
            <div class="user-box">

                <img src="{{ current_user.avatar or url_for('static', filename='img/default-user.png') }}" 
                     class="user-avatar">

                <p class="username">@{{ current_user.username }}</p>

                <button class="toggle-create-btn" onclick="toggleCreateForum()">Criar Fórum</button>

                <div id="create-forum-box" class="create-box hidden">
                    <form method="POST">
                        <label>Nome do Fórum</label>
                        <input type="text" name="create_name" placeholder="Nome..." required>

                        <label>Descrição</label>
                        <input type="text" name="create-desc" placeholder="Descrição..." required>

                        <button type="submit" class="btn">Criar</button>
                    </form>
                </div>

            </div>

            {% else %}

            <div class="user-box">
                <p>Você não está logado.</p>
                <a href="{{ url_for('auth.login') }}">
                    <button class="login-btn">Entrar</button>
                </a>
            </div>

            {% endif %}

        </aside>



        <!-- ================= CENTRO: FEED ================= -->
        <main class="feed">

            <h3 class="section-title">Fóruns Disponíveis</h3>

            <div class="forum-list" id="rooms-list">

                {% if rooms|length == 0 %}
                    <p id="no-rooms-msg">Nenhum fórum criado ainda.</p>
                {% endif %}

                {% for room in rooms %}
                <div class="forum-card">
                    <form method="POST">
                        <h4>{{ room.name }}</h4>
                        <p>{{ room.description }}</p>

                        <button type="submit" class="btn" 
                                name="entrar" value="{{ room.id }}">
                            Entrar
                        </button>
                    </form>
                </div>
                {% endfor %}

            </div>

        </main>



        <!-- ================= DIREITA: ONLINE ================= -->
        <aside class="right-sidebar">
            <h3>Usuários Online</h3>
            <ul id="online-list"></ul>
        </aside>

    </div> <!-- home-layout -->

</div> <!-- home-container -->



<!-- ================= SOCKET.IO ================= -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<script>
    const socket = io();

    /* --- Atualiza lista de novos fóruns instantaneamente --- */
    socket.on("new_room", (data) => {
        const list = document.getElementById("rooms-list");
        const noRooms = document.getElementById("no-rooms-msg");
        if (noRooms) noRooms.remove();

        const card = document.createElement("div");
        card.classList.add("forum-card");

        card.innerHTML = `
            <form method="POST">
                <h4>${data.name}</h4>
                <p>${data.description}</p>
                <button type="submit" class="btn" name="entrar" value="${data.id}">
                    Entrar
                </button>
            </form>
        `;

        list.appendChild(card);
    });

    /* --- Atualiza lista de usuários online --- */
    socket.on("online_users", users => {
        const list = document.getElementById("online-list");
        list.innerHTML = "";

        users.forEach(username => {
            let li = document.createElement("li");
            li.textContent = username;
            list.appendChild(li);
        });
    });

    /* --- Abre/fecha box de criar fórum --- */
    function toggleCreateForum() {
        document.getElementById("create-forum-box").classList.toggle("hidden");
    }

</script>

{% endblock %}
