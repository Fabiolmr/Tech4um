{% extends 'base.html' %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>

<style>
    /* =======================================================
    ESTILOS GLOBAIS (Otimizados para Est√©tica)
    =======================================================
    */
    :root {
        --color-primary: #FF4500;
        --color-secondary: #E63E00;
        --color-background: #1F2937;
        --color-card-bg: #374151;
        --color-header: #111827;
        --color-text-light: #F3F4F6;
        --color-border-dark: #4B5563;
        --color-input-bg: #4B5563;
        --color-muted: #9CA3AF;
        --color-link-hover: #FF4500;
        --header-height: 64px; 
        --color-light-gray-box: #FF4500; /* NOVO: Cinza Claro para a caixa de formul√°rio */
        --color-forum-box-bg: #4B5563; /* NOVO: Fundo Cinza Claro para a caixa do formul√°rio */
    }

    body {
        background-color: var(--color-background);
        color: var(--color-text-light);
        font-family: 'Inter', sans-serif;
    }
        /* REGRAS ESPEC√çFICAS: CAIXA DE CRIA√á√ÉO */
    #create-forum-box.app-card {
        background-color: var(--color-forum-box-bg);
    }

    #create-forum-box label {
        color: var(--color-text-light);
        display: block;
        text-align: left;
        font-weight: 500;
        font-size: 0.875rem;
        line-height: 1.25rem;
        margin-bottom: 0.25rem;
    }

    #create-forum-box input[type="text"] {
        margin-bottom: 1rem; 
        border-radius: 0.2rem;
        background-color: var(--color-input-bg);
        color: var(--color-text-light);
    }


    /* Bot√£o Gradiente (Principal) */
    .btn-gradiente {
        background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
        color: white;
        padding: 0.75rem 1rem; /* Padding aumentado */
        border-radius: 0.5rem;
        font-weight: 600;
        transition: opacity 0.2s, box-shadow 0.2s;
        border: none;
        cursor: pointer;
    }
    .btn-gradiente:hover {
        opacity: 0.9;
        box-shadow: 0 4px 15px rgba(255, 69, 0, 0.6); /* Sombra mais forte */
    }
    
    /* Bot√£o Secund√°rio */
    .btn-secondary {
        background-color: var(--color-border-dark);
        color: var(--color-text-dark);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: background-color 0.2s;
        border: none;
        cursor: pointer;
    }
    .btn-secondary:hover {
        background-color: #5d6874;
    }

    /* Card Padr√£o - AUMENTAMOS O ARREDONDAMENTO */
    .app-card {
        background-color: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 1rem; /* Mais arredondado */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* Estilo para T√≠tulo da Se√ß√£o */
    .section-title {
        border-bottom: 2px solid var(--color-primary);
        padding-bottom: 12px; /* Mais espa√ßo embaixo do underline */
        margin-bottom: 30px !important; /* Mais margem inferior */
        color: var(--color-primary);
    }

    /* Estilo dos Cards de F√≥rum (Main Feed) - MAIS ESPA√áO E ANIMA√á√ÉO */
    .forum-card {
        transition: transform 0.2s, border-color 0.2s;
        border-left: 5px solid var(--color-border-dark); 
        padding: 20px; /* Padding interno aumentado */
    }
    .forum-card:hover {
        transform: translateY(-3px); /* Anima√ß√£o sutil */
        border-left: 5px solid var(--color-primary); 
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4); /* Sombra mais destacada */
    }

    /* Ocultar box de cria√ß√£o de f√≥rum */
    .hidden {
        display: none !important;
    }

    /* Ajuste de Margem para o Layout Principal */
    .home-container {
        padding-top: calc(var(--header-height) + 2rem); /* Compensa o header fixo */
    }

    /* Ajustes espec√≠ficos para a sidebar */
    .user-box, .sidebar-menu, .right-sidebar .app-card {
        border-radius: 1rem;
    }
    .right-sidebar .app-card {
        border-left: 5px solid var(--color-primary); /* Borda para destacar o Online */
    }

</style>

<header class="sticky top-0 z-10 p-4 border-b border-gray-700 flex justify-between items-center shadow-lg"
        style="height: var(--header-height); background-color: var(--color-header);">
    <div class="header-left">
        <a href="{{ url_for('main.home') }}" class="logo">TecH4um</a>
    </div>
    
    <div class="header-right">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}">
            <button class="logout-btn btn-gradiente text-sm">Sair</button>
        </a>
        {% else %}
        <a href="{{ url_for('auth.login') }}">
            <button class="header-login-btn btn-gradiente text-sm">Entrar</button>
        </a>
        {% endif %}
    </div>
</header>

<div class="home-container p-4">

    <div class="home-layout grid grid-cols-1 md:grid-cols-12 gap-8 max-w-7xl mx-auto">


        <aside class="left-sidebar md:col-span-3">

            {% if current_user.is_authenticated %}
            <div class="user-box p-4 mb-6 app-card text-center">

                {% if current_user.avatar_url %}
                    <img src="{{ current_user.avatar_url }}" 
                         class="user-avatar w-16 h-16 rounded-full mx-auto mb-3 border-2 border-orange-500 object-cover">
                {% else %}
                    <img src="{{ avatars.gravatar(current_user.email, size=200, default='identicon') }}" 
                         class="user-avatar w-16 h-16 rounded-full mx-auto mb-3 border-2 border-orange-500 object-cover">
                {% endif %}

                <p class="username text-lg font-semibold mb-3">@{{ current_user.username }}</p>

                <button class="toggle-create-btn btn-gradiente w-full mb-2" onclick="toggleCreateForum()">
                    + Criar F√≥rum
                </button>
                <button class="perfil-btn btn-secondary w-full" 
                        onclick="window.location.href = '{{ url_for('main.perfil', username=current_user.username) }}'">
                    üë§ Meu Perfil
                </button>
                
                <div id="create-forum-box" class="create-box p-4 mt-3 app-card hidden text-left">
                    <form method="POST">
                        <label for="create_name">Nome do F√≥rum</label>
                        <input type="text" id="create_name" name="create_name" placeholder="Nome..." required>

                        <label for="create_desc">Descri√ß√£o</label>
                        <input type="text" id="create_desc" name="create_desc" placeholder="Descri√ß√£o..." required>

                        <button type="submit" class="btn btn-gradiente w-full mt-2">Criar</button>
                    </form>
                </div>

            </div>

            <div class="sidebar-menu p-2 app-card">
                <h4 class="text-xs font-semibold uppercase text-gray-400 mb-2 px-2">Navega√ß√£o</h4>
                <ul class="space-y-1">
                    <li>
                        <button onclick="toggleForumsMenu()" 
                                class="sidebar-link w-full flex justify-between items-center group focus:outline-none btn-gradiente w-full" >
                            <span class="flex items-center gap-2">
                                Meus F√≥runs
                            </span>
                            <span id="menu-arrow" class="text-xs text-gray-500 transform transition-transform duration-200 group-hover:text-white">
                                ‚ñº
                            </span>
                        </button>
                    
                        <ul id="forums-submenu" class="hidden mt-1 pl-2 border-l-2 border-gray-700 ml-3 space-y-1 transition-all">
                            {% set has_forums = false %}
                            {% for room in rooms %}
                                {% if current_user.is_authenticated and current_user in room.members %}
                                    {% set has_forums = true %}
                                    <li>
                                        <a href="{{ url_for('chat.access_forum', forum_id=room.id) }}" 
                                           class="block p-2 text-sm text-gray-300 hover:text-white hover:bg-gray-700 rounded transition-colors truncate"
                                           title="{{ room.name }}">
                                            üí¨ {{ room.name }}
                                        </a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                                
                            {% if not has_forums %}
                                <li class="p-2 text-xs text-gray-500 italic">
                                    Voc√™ ainda n√£o participa de nenhum f√≥rum.
                                </li>
                            {% endif %}
                        </ul>
                    </li>
                </ul>
            </div>

            {% else %}

            <div class="user-box p-4 app-card text-center">
                <p class="mb-3">Voc√™ n√£o est√° logado.</p>
                <a href="{{ url_for('auth.login') }}">
                    <button class="login-btn btn-gradiente w-full">Entrar</button>
                </a>
                <p class="text-sm text-gray-400 mt-2">ou <a href="{{ url_for('auth.register') }}" class="text-orange-400 hover:text-orange-300">Criar Conta</a></p>
            </div>

            {% endif %}

        </aside>



        <main class="feed md:col-span-6">
            <h3 class="section-title text-2xl font-bold">F√≥runs Dispon√≠veis</h3>

            <div class="forum-list space-y-5" id="rooms-list">

                {% if rooms|length == 0 %}
                    <p id="no-rooms-msg" class="p-4 app-card text-center text-gray-400">Nenhum f√≥rum criado ainda.</p>
                {% endif %}

                {% for room in rooms %}
                <div class="forum-card app-card p-4">
                    <form method="POST" class="forum-form flex justify-between items-start">
                        <input type="hidden" name="forum_id" value="{{ room.id }}">

                        <div class="card-info flex-grow">
                            <h4 class="text-xl font-semibold text-orange-300">{{ room.name }}</h4>
                            <p class="text-gray-300 mt-1 mb-3">{{ room.description }}</p>
                            <p id="count-{{ room.id }}" class="text-xs text-gray-400">
                                üë• {{ room.members|length }} membro(s)
                            </p>
                        </div>
                        
                        <div class="card-actions flex flex-col space-y-2 ml-4 min-w-[150px] items-end">
                            {% if current_user.is_authenticated %}
                                
                                {% if current_user in room.members %}
                                    <button type="submit" 
                                            formaction="{{ url_for('main.leave_member', forum_id=room.id) }}"
                                            class="text-xs text-red-400 hover:text-red-300 transition-colors self-end"
                                            title="Sair deste f√≥rum">
                                        Sair
                                    </button>
                                    <a href="{{ url_for('chat.access_forum', forum_id=room.id) }}" class="w-full">
                                        <button type="button" 
                                                class="btn btn-gradiente w-full text-sm">
                                            Entrar no Chat
                                        </button>
                                    </a>
                                {% else %}
                                    <button type="submit" 
                                            formaction="{{ url_for('main.join_member', forum_id=room.id) }}" 
                                            class="btn btn-gradiente w-full text-sm">
                                        Ser Membro
                                    </button>
                                    <a href="{{ url_for('chat.access_forum', forum_id=room.id) }}" class="w-full">
                                        <button type="button" 
                                                class="btn btn-secondary w-full text-xs mt-1">
                                            Entrar (Visitante)
                                        </button>
                                    </a>
                                {% endif %}

                            {% else %}
                                <a href="{{ url_for('auth.login') }}" class="w-full">
                                    <button type="button" class="btn btn-gradiente w-full text-sm">
                                        Entrar / Logar
                                    </button>
                                </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
                {% endfor %}
            </div>
        </main>



        <aside class="right-sidebar md:col-span-3">
            <div class="app-card p-4">
                <h3 class="text-xl font-bold mb-4 text-orange-400">Usu√°rios Online</h3>
                <ul id="online-list" class="space-y-1 text-gray-300">
                    <li>Conectando...</li>
                </ul>
            </div>
        </aside>

    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<script>
    const socket = io();

    // Use o valor 'None' (string) ou string vazia se n√£o autenticado
    const currentUser = "{{ current_user.username if current_user.is_authenticated else '' }}"; 

    /* --- Garante que a p√°gina recarregue no "Back" do navegador --- */
    window.addEventListener("pageshow", function (event) {
        var historyTraversal = event.persisted || 
                                (typeof window.performance != "undefined" && 
                                 window.performance.navigation.type === 2);
        
        if (historyTraversal) {
            window.location.reload();
        }
    });

    /* --- Abre/fecha box de criar f√≥rum --- */
    function toggleCreateForum() {
        const box = document.getElementById("create-forum-box");
        if(box) {
            box.classList.toggle("hidden");
        }
    }
    window.toggleCreateForum = toggleCreateForum; 


    /* --- Menu Meus F√≥runs (Toggle) --- */
    function toggleForumsMenu() {
        const submenu = document.getElementById('forums-submenu');
        const arrow = document.getElementById('menu-arrow');
        
        submenu.classList.toggle('hidden');
        
        // Gira a seta
        if (submenu.classList.contains('hidden')) {
            arrow.style.transform = 'rotate(0deg)';
        } else {
            arrow.style.transform = 'rotate(180deg)';
        }
        
        // Salva estado
        const isOpen = !submenu.classList.contains('hidden');
        localStorage.setItem('forumsMenuOpen', isOpen);
    }

    // Restaura estado ao recarregar
    document.addEventListener("DOMContentLoaded", function() {
        const submenu = document.getElementById('forums-submenu');
        const arrow = document.getElementById('menu-arrow');
        const wasOpen = localStorage.getItem('forumsMenuOpen') === 'true';

        if (wasOpen && submenu && arrow) {
            submenu.classList.remove('hidden');
            arrow.style.transform = 'rotate(180deg)';
        }
    });

    /* --- Atualiza lista de novos f√≥runs instantaneamente (via Socket.IO) --- */
    socket.on("new_room", (data) => {
        const list = document.getElementById("rooms-list");
        const noRooms = document.getElementById("no-rooms-msg");
        if (noRooms) noRooms.remove();

        const card = document.createElement("div");
        card.classList.add("forum-card", "app-card", "p-4"); 
        card.id = `card-${data.id}`;

        let actionsHTML = '';
        const memberCount = 1;
        
        const enterButtonHTML = `
             <a href="/chat/access/${data.id}" class="w-full">
                <button type="button" 
                        class="btn btn-gradiente w-full text-sm">
                    Entrar
                </button>
             </a>`;

        // L√≥gica de autentica√ß√£o e membro no novo card 
        if (currentUser) {
             if (currentUser === data.creator) {
                  // Criador: Apenas o bot√£o Entrar (Link)
                  actionsHTML = enterButtonHTML;
             } else {
                  // N√£o criador, mas logado: Ser Membro (POST) + Entrar (Link)
                  actionsHTML = `
                      <button type="submit" formaction="/join_member/${data.id}" class="btn btn-secondary w-full text-sm">
                          Ser Membro
                      </button>
                      ${enterButtonHTML}`;
             }
        } else {
             // N√£o logado: Apenas Entrar (Link para Login)
             actionsHTML = `<a href="/login" class="w-full"><button type="button" class="btn btn-gradiente w-full text-sm">Entrar</button></a>`;
        }
        
        card.innerHTML = `
            <form method="POST" class="forum-form flex justify-between items-start">
                <input type="hidden" name="forum_id" value="${data.id}">
                <div class="card-info flex-grow">
                    <h4 class="text-xl font-semibold text-orange-300">${data.name}</h4>
                    <p class="text-gray-300 mt-1 mb-3">${data.description}</p>
                    <p class="member-count text-xs text-gray-400" id="count-${data.id}">
                        üë• ${memberCount} membro(s)
                    </p>
                </div>
                <div class="card-actions flex flex-col space-y-2 ml-4 min-w-[150px] items-end">
                    ${actionsHTML}
                </div>
            </form>
        `;

        list.prepend(card); 
    });

    /* --- Atualiza a contagem de membros (via Socket.IO) --- */
    socket.on("update_member_count", (data) => {
        const countEl = document.getElementById(`count-${data.forum_id}`);
        if (countEl) {
            countEl.innerHTML = `üë• ${data.count} membro(s)`;
        }
    });

    /* --- Atualiza lista de usu√°rios online (via Socket.IO) --- */
    socket.on("online_users", users => {
        const list = document.getElementById("online-list");
        if(list){
            list.innerHTML = "";
            if (users.length === 0) {
                 let li = document.createElement("li");
                 li.textContent = "Ningu√©m online agora.";
                 li.classList.add("text-gray-500");
                 list.appendChild(li);
            } else {
                users.forEach(username => {
                    let li = document.createElement("li");
                    li.textContent = `@${username}`;
                    if (username === currentUser) {
                        li.classList.add("font-bold", "text-orange-400");
                        li.textContent += " (Voc√™)";
                    } else {
                        li.classList.add("hover:text-orange-300", "cursor-pointer");
                    }
                    list.appendChild(li);
                });
            }
        }
    });
</script>

{% endblock %}