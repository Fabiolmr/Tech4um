{% extends 'base.html' %}

{% block content %}


<!-- ================= HEADER SUPERIOR ================= -->
<header>
    <div class="header-left">
        <a href="{{ url_for('main.home') }}" class="logo">TecH4um</a>
    </div>
    
    <div class="topbar">
        </div>
        
    <div class="header-right">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}">
            <button class="logout-btn btn-gradiente">Sair</button>
        </a>
        {% else %}
        <a href="{{ url_for('auth.login') }}">
            <button class="header-login-btn">Entrar</button>
        </a>
        {% endif %}
    </div>
</header>

<div class="home-container">




    <!-- ================= LAYOUT PRINCIPAL ================= -->
    <div class="home-layout">


        <!-- ================= ESQUERDA: SIDEBAR ================= -->
        <aside class="left-sidebar">

            {% if current_user.is_authenticated %}
            <div class="user-box">

                <img src="{{ current_user.avatar or url_for('static', filename='img/default-user.png') }}" 
                     class="user-avatar">

                <p class="username">@{{ current_user.username }}</p>

                <button class="toggle-create-btn btn-gradiente" onclick="toggleCreateForum()">
                    + Criar FÃ³rum
                </button>
                <button class="perfil-btn btn-gradiente" 
                        onclick="window.location.href = '{{ url_for('main.perfil', username=current_user.username) }}'">
                    ðŸ‘¤ Meu Perfil
                </button>
                
                <div id="create-forum-box" class="create-box hidden">
                    <form method="POST">
                        <label>Nome do FÃ³rum</label>
                        <input type="text" name="create_name" placeholder="Nome..." required>

                        <label>DescriÃ§Ã£o</label>
                        <input type="text" name="create-desc" placeholder="DescriÃ§Ã£o..." required>

                        <button type="submit" class="btn btn-gradiente">Criar</button>
                    </form>
                </div>

            </div>

            <div class="sidebar-menu">
                <ul>
                    <li><a href="{{ url_for('main.home') }}" class="sidebar-link active">FÃ³runs</a></li>
                </ul>
            </div>

            {% else %}

            <div class="user-box">
                <p>VocÃª nÃ£o estÃ¡ logado.</p>
                <a href="{{ url_for('auth.login') }}">
                    <button class="login-btn">Entrar</button>
                </a>
            </div>

            {% endif %}

        </aside>



        <!-- ================= CENTRO: FEED ================= -->
        <main class="feed">

            <h3 class="section-title">FÃ³runs DisponÃ­veis</h3>

            <div class="forum-list" id="rooms-list">

                {% if rooms|length == 0 %}
                    <p id="no-rooms-msg">Nenhum fÃ³rum criado ainda.</p>
                {% endif %}

                {% for room in rooms %}
                <div class="forum-card">
                    <form method="POST" class="forum-form">
                        <div class="card-info">
                            <h4>{{ room.name }}</h4>
                            <p>{{ room.description }}</p>
                            <p id="count-{{ room.id }}" style="font-size: 0.8em; color: #818384; margin-top: 5px;">
                                ðŸ‘¥ {{ room.members|length }} membro(s)
                            </p>
                        </div>
                        <div class="card-actions">
                            {% if current_user.is_authenticated %}
                                {% if current_user.username in room.members %}
                                    <span style="color: #4CAF50; font-weight: bold; margin-right: 10px;">
                                        âœ“ Membro
                                    </span>
                                {% else %}
                                    <button type="submit" formaction="{{ url_for('main.join_member', forum_id=room.id) }}" class="btn btn-secondary">
                                        Ser Membro
                                    </button>
                                {% endif %}
                            {% endif %}
                            
                            <button type="submit" class="btn btn-gradiente enter-btn" 
                                    name="entrar" value="{{ room.id }}">
                                Entrar
                            </button>
                        </div>
                    </form>
                </div>
                {% endfor %}
            </div>
        </main>



        <!-- ================= DIREITA: ONLINE ================= -->
        <aside class="right-sidebar">
            <h3>UsuÃ¡rios Online</h3>
            <ul id="online-list"></ul>
        </aside>

    </div> <!-- home-layout -->

</div> <!-- home-container -->



<!-- ================= SOCKET.IO ================= -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<script>
    const socket = io();

    const currentUser = "{{ current_user.username if current_user.is_authenticated else '' }}";

    window.addEventListener("pageshow", function (event) {
        var historyTraversal = event.persisted || 
                               (typeof window.performance != "undefined" && 
                                window.performance.navigation.type === 2);
        
        if (historyTraversal) {
            window.location.reload();
        }
    });

    /* --- Atualiza lista de novos fÃ³runs instantaneamente --- */
    socket.on("new_room", (data) => {
        const list = document.getElementById("rooms-list");
        const noRooms = document.getElementById("no-rooms-msg");
        if (noRooms) noRooms.remove();

        const card = document.createElement("div");
        card.classList.add("forum-card");
        card.id = `card-${data.id}`;

        let memberButtonHTML = '';

        if (currentUser === data.creator) {
            memberButtonHTML = `
                <span class="badge-member" style="color: #4CAF50; font-weight: bold; margin-left: 10px;">
                    âœ“ Membro
                </span>`;
        } else if (currentUser) {
            actionsHTML = `
                <button type="submit" formaction="/join_member/${data.id}" class="btn btn-secondary">
                    Ser Membro
                </button>`;
        }

        card.innerHTML = `
            <form method="POST" class="forum-form">
                <div class="card-info">
                    <h4>${data.name}</h4>
                    <p>${data.description}</p>
                    <p class="member-count" id="count-${data.id}" style="font-size: 0.8em; color: #818384; margin-top: 5px;">
                        ðŸ‘¥ 1 membro(s)
                    </p>
                </div>
                <div class="card-actions">
                    ${actionsHTML}
                    <button type="submit" class="btn btn-gradiente enter-btn" name="entrar" value="${data.id}">
                        Entrar
                    </button>
                </div>
            </form>
        `;

        list.appendChild(card);
    });

    socket.on("update_member_count", (data) => {
        const countEl = document.getElementById(`count-${data.forum_id}`);
        if (countEl) {
            countEl.innerHTML = `ðŸ‘¥ ${data.count} membro(s)`;
        }
    });

    /* --- Atualiza lista de usuÃ¡rios online --- */
    socket.on("online_users", users => {
        const list = document.getElementById("online-list");
        if(list){
        list.innerHTML = "";
        users.forEach(username => {
            let li = document.createElement("li");
            li.textContent = username;
            list.appendChild(li);
            });
        }
    });

    /* --- Abre/fecha box de criar fÃ³rum --- */
   function toggleCreateForum() {
        const box = document.getElementById("create-forum-box");
        if(box) box.classList.toggle("hidden");
    }
</script>

{% endblock %}
