{% extends 'base.html' %}

{% block content %}
<script src="https://cdn.tailwindcss.com"></script>

<style>
    /* =======================================================
    ESTILOS GLOBAIS (Laranja Vibrante / Dark Mode)
    Copiei do seu template de login para consist√™ncia
    =======================================================
    */
    :root {
        --color-primary: #FF4500; /* Laranja Vibrante */
        --color-secondary: #E63E00; /* Laranja um pouco mais escuro para hover */
        --color-background: #1F2937; /* Tailwind Gray 800 - Fundo principal */
        --color-card-bg: #374151; /* Tailwind Gray 700 - Fundo do card */
        --color-text-light: #F3F4F6; /* Tailwind Gray 100 - Texto claro */
        --color-border-dark: #4B5563; /* Tailwind Gray 600 - Bordas e divisores */
        --color-input-bg: #4B5563;
        --color-muted: #9CA3AF;
        --color-link-hover: #FF7F50; /* Um laranja mais suave para links/hover */
    }

    body {
        background-color: var(--color-background);
        color: var(--color-text-light);
        font-family: 'Inter', sans-serif;
    }

    /* Bot√£o Gradiente (Principal) */
    .btn-gradiente {
        background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: opacity 0.2s, box-shadow 0.2s;
        border: none;
        cursor: pointer;
    }
    .btn-gradiente:hover {
        opacity: 0.9;
        box-shadow: 0 4px 12px rgba(255, 69, 0, 0.4);
    }
    
    /* Bot√£o Secund√°rio */
    .btn-secondary {
        background-color: var(--color-border-dark);
        color: var(--color-text-light);
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: background-color 0.2s;
        border: none;
        cursor: pointer;
    }
    .btn-secondary:hover {
        background-color: #5d6874; /* Um pouco mais claro */
    }

    /* Card Padr√£o */
    .app-card {
        background-color: var(--color-card-bg);
        border: 1px solid var(--color-border-dark);
        border-radius: 0.75rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* Input/Form de Cria√ß√£o de F√≥rum */
    .create-box input[type="text"] {
        background-color: var(--color-input-bg);
        border: 1px solid var(--color-border-dark);
        color: var(--color-text-light);
        padding: 0.5rem;
        border-radius: 0.375rem;
        width: 100%;
        margin-bottom: 0.75rem;
        margin-top: 0.25rem;
    }
    .create-box label {
        display: block;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }
    
    /* Estilos do Link da Sidebar */
    .sidebar-menu a {
        display: block;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s, color 0.2s;
        color: var(--color-text-light);
        text-decoration: none;
    }
    .sidebar-menu a:hover {
        background-color: var(--color-border-dark);
        color: var(--color-primary);
    }
    .sidebar-menu .active {
        background-color: var(--color-primary);
        color: white;
        font-weight: 600;
    }
    .sidebar-menu .active:hover {
        background-color: var(--color-secondary);
        color: white;
    }

    /* Ajuste para o logo no header */
    .logo {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--color-primary);
        text-decoration: none;
    }
    .logo:hover {
        color: var(--color-secondary);
    }
    
    /* Ocultar box de cria√ß√£o de f√≥rum */
    .hidden {
        display: none !important;
    }

</style>

<header class="sticky top-0 z-10 p-4 border-b border-gray-700 flex justify-between items-center app-card rounded-none shadow-lg">
    <div class="header-left">
        <a href="{{ url_for('main.home') }}" class="logo">TecH4um</a>
    </div>
    
    <div class="header-right">
        {% if current_user.is_authenticated %}
        <a href="{{ url_for('auth.logout') }}">
            <button class="logout-btn btn-gradiente text-sm">Sair</button>
        </a>
        {% else %}
        <a href="{{ url_for('auth.login') }}">
            <button class="header-login-btn btn-gradiente text-sm">Entrar</button>
        </a>
        {% endif %}
    </div>
</header>

<div class="home-container p-4">

    <div class="home-layout grid grid-cols-1 md:grid-cols-12 gap-6 max-w-7xl mx-auto">


        <aside class="left-sidebar md:col-span-3">

            {% if current_user.is_authenticated %}
            <div class="user-box p-4 mb-4 app-card text-center">

                {% if current_user.avatar_url %}
                    <img src="{{ current_user.avatar_url }}" 
                         class="user-avatar w-16 h-16 rounded-full mx-auto mb-3 border-2 border-orange-500 object-cover">
                {% else %}
                    <img src="{{ avatars.gravatar(current_user.email, size=200, default='identicon') }}" 
                         class="user-avatar w-16 h-16 rounded-full mx-auto mb-3 border-2 border-orange-500 object-cover">
                {% endif %}

                <p class="username text-lg font-semibold mb-3">@{{ current_user.username }}</p>

                <button class="toggle-create-btn btn-gradiente w-full mb-2" onclick="toggleCreateForum()">
                    + Criar F√≥rum
                </button>
                <button class="perfil-btn btn-secondary w-full" 
                        onclick="window.location.href = '{{ url_for('main.perfil', username=current_user.username) }}'">
                    üë§ Meu Perfil
                </button>
                
                <div id="create-forum-box" class="create-box p-4 mt-3 app-card hidden text-left">
                    <form method="POST">
                        <label for="create_name">Nome do F√≥rum</label>
                        <input type="text" id="create_name" name="create_name" placeholder="Nome..." required>

                        <label for="create_desc">Descri√ß√£o</label>
                        <input type="text" id="create_desc" name="create-desc" placeholder="Descri√ß√£o..." required>

                        <button type="submit" class="btn btn-gradiente w-full mt-2">Criar</button>
                    </form>
                </div>

            </div>

            <div class="sidebar-menu p-2 app-card">
                <h4 class="text-xs font-semibold uppercase text-gray-400 mb-2 px-2">Navega√ß√£o</h4>
                <ul>
                    <li><a href="{{ url_for('main.home') }}" class="sidebar-link active">F√≥runs</a></li>
                    </ul>
            </div>

            {% else %}

            <div class="user-box p-4 app-card text-center">
                <p class="mb-3">Voc√™ n√£o est√° logado.</p>
                <a href="{{ url_for('auth.login') }}">
                    <button class="login-btn btn-gradiente w-full">Entrar</button>
                </a>
                <p class="text-sm text-gray-400 mt-2">ou <a href="{{ url_for('auth.register') }}" class="text-orange-400 hover:text-orange-300">Criar Conta</a></p>
            </div>

            {% endif %}

        </aside>



        <main class="feed md:col-span-6">

            <h3 class="section-title text-2xl font-bold mb-4 text-orange-400">F√≥runs Dispon√≠veis</h3>

            <div class="forum-list space-y-4" id="rooms-list">

                {% if rooms|length == 0 %}
                    <p id="no-rooms-msg" class="p-4 app-card text-center text-gray-400">Nenhum f√≥rum criado ainda.</p>
                {% endif %}

                {% for room in rooms %}
                <div class="forum-card app-card p-4">
                    <form method="POST" class="forum-form flex justify-between items-center">
                        <div class="card-info flex-grow">
                            <h4 class="text-xl font-semibold text-orange-300">{{ room.name }}</h4>
                            <p class="text-gray-400 mt-1 mb-2">{{ room.description }}</p>
                            <p id="count-{{ room.id }}" class="text-xs text-gray-400">
                                üë• {{ room.members|length }} membro(s)
                            </p>
                        </div>
                        
                        <div class="card-actions flex flex-col space-y-2 ml-4 min-w-[120px]">
                            {% if current_user.is_authenticated %}
                                {% if current_user.username in room.members %}
                                    <button type="submit" 
                                            formaction="{{ url_for('main.leave_member', forum_id=room.id) }}"
                                            class="btn btn-secondary text-sm border border-transparent hover:border-red-500 hover:text-red-400 transition-colors"
                                            title="Sair deste f√≥rum">
                                        Sair
                                    </button>
                                {% else %}
                                    <button type="submit" 
                                            formaction="{{ url_for('main.join_member', forum_id=room.id) }}" 
                                            class="btn btn-secondary text-sm">
                                        Ser Membro
                                    </button>
                                {% endif %}
                            {% endif %}
                            
                            <button type="submit" class="btn btn-gradiente enter-btn text-sm" 
                                    name="entrar" value="{{ room.id }}">
                                Entrar
                            </button>
                        </div>
                    </form>
                </div>
                {% endfor %}
            </div>
        </main>



        <aside class="right-sidebar md:col-span-3">
            <div class="app-card p-4">
                <h3 class="text-xl font-bold mb-4 text-orange-400">Usu√°rios Online</h3>
                <ul id="online-list" class="space-y-1 text-gray-300">
                    <li>Conectando...</li>
                </ul>
            </div>
        </aside>

    </div> </div> <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>

<script>
    const socket = io();

    // Use o valor 'None' (string) ou string vazia se n√£o autenticado
    const currentUser = "{{ current_user.username if current_user.is_authenticated else '' }}"; 

    /* --- Garante que a p√°gina recarregue no "Back" do navegador --- */
    window.addEventListener("pageshow", function (event) {
        var historyTraversal = event.persisted || 
                               (typeof window.performance != "undefined" && 
                                window.performance.navigation.type === 2);
        
        if (historyTraversal) {
            window.location.reload();
        }
    });

    /* --- Abre/fecha box de criar f√≥rum --- */
    function toggleCreateForum() {
        const box = document.getElementById("create-forum-box");
        // Verifica se o box existe antes de tentar manipular as classes
        if(box) {
            box.classList.toggle("hidden");
        }
    }
    
    // Deixa a fun√ß√£o globalmente acess√≠vel
    window.toggleCreateForum = toggleCreateForum; 


    /* --- Atualiza lista de novos f√≥runs instantaneamente (via Socket.IO) --- */
    socket.on("new_room", (data) => {
        const list = document.getElementById("rooms-list");
        const noRooms = document.getElementById("no-rooms-msg");
        if (noRooms) noRooms.remove();

        const card = document.createElement("div");
        card.classList.add("forum-card", "app-card", "p-4"); // Adicionadas classes de estilo
        card.id = `card-${data.id}`;

        let actionsHTML = '';
        const memberCount = 1; // Novo f√≥rum, 1 membro (o criador)
        
        // L√≥gica de autentica√ß√£o e membro no novo card (usando classes Tailwind/CSS)
        if (currentUser) {
            if (currentUser === data.creator) {
                 // Criador √© sempre membro
                actionsHTML = `
                    <span class="text-green-400 font-bold text-sm text-center">
                        ‚úì Membro
                    </span>`;
            } else {
                 // N√£o criador, mas logado: pode ser membro
                actionsHTML = `
                    <button type="submit" formaction="/join_member/${data.id}" class="btn btn-secondary text-sm">
                        Ser Membro
                    </button>`;
            }
        }
        
        // Bot√£o Entrar sempre presente se for um f√≥rum
        const enterButtonHTML = `
            <button type="submit" class="btn btn-gradiente enter-btn text-sm" name="entrar" value="${data.id}">
                Entrar
            </button>`;

        card.innerHTML = `
            <form method="POST" class="forum-form flex justify-between items-center">
                <div class="card-info flex-grow">
                    <h4 class="text-xl font-semibold text-orange-300">${data.name}</h4>
                    <p class="text-gray-400 mt-1 mb-2">${data.description}</p>
                    <p class="member-count text-xs text-gray-400" id="count-${data.id}">
                        üë• ${memberCount} membro(s)
                    </p>
                </div>
                <div class="card-actions flex flex-col space-y-2 ml-4 min-w-[120px]">
                    ${actionsHTML}
                    ${enterButtonHTML}
                </div>
            </form>
        `;

        list.prepend(card); // Adiciona no topo para ver o novo f√≥rum
    });

    /* --- Atualiza a contagem de membros (via Socket.IO) --- */
    socket.on("update_member_count", (data) => {
        const countEl = document.getElementById(`count-${data.forum_id}`);
        if (countEl) {
            countEl.innerHTML = `üë• ${data.count} membro(s)`;
        }
    });

    /* --- Atualiza lista de usu√°rios online (via Socket.IO) --- */
    socket.on("online_users", users => {
        const list = document.getElementById("online-list");
        if(list){
            list.innerHTML = "";
            if (users.length === 0) {
                 let li = document.createElement("li");
                 li.textContent = "Ningu√©m online agora.";
                 li.classList.add("text-gray-500");
                 list.appendChild(li);
            } else {
                users.forEach(username => {
                    let li = document.createElement("li");
                    li.textContent = username;
                    // Opcional: destaque o usu√°rio atual
                    if (username === currentUser) {
                        li.classList.add("font-bold", "text-orange-400");
                        li.textContent += " (Voc√™)";
                    } else {
                        li.classList.add("hover:text-orange-300", "cursor-pointer");
                    }
                    list.appendChild(li);
                });
            }
        }
    });
</script>

{% endblock %}